<!DOCTYPE html>
<html>

	<head>
		<script src="../stitch.js"></script>
		<style>
			svg {
				margin: auto;
				position: absolute;
				inset: 0;
			}
		</style>
		<script>
			let stitchData = {"size":1000,"letters":[{"char":"s","paths":[[-417,139,-406,138,-396,138,-385,136,-374,134,-364,131,-354,126,-346,120,-339,111,-334,101,-332,91,-331,80,-332,69,-334,59,-339,49,-346,41,-354,34,-364,29,-374,24,-384,19,-393,15,-403,10,-410,2,-406,-8,-395,-8,-386,-2,-379,6,-370,13,-360,16,-349,15,-340,9,-335,-1,-334,-11,-336,-22,-341,-32,-349,-39,-358,-44,-369,-48,-379,-50,-390,-51,-401,-52,-412,-52,-423,-51,-433,-50,-444,-49,-455,-46,-465,-43,-474,-37,-483,-31,-489,-22,-493,-12,-496,-1,-496,10,-495,20,-492,31,-487,40,-480,48,-471,55,-462,61,-452,65,-442,69,-432,73,-422,78,-419,88,-427,94,-437,93,-447,89,-455,81,-463,74,-472,68,-483,67,-492,71,-498,81,-500,91,-499,102,-496,112,-489,121,-481,127,-471,132,-460,135,-450,137,-439,138,-428,138]]},{"char":"t","paths":[[-227,139,-216,138,-205,137,-194,134,-185,129,-179,120,-177,109,-176,98,-178,87,-183,78,-193,74,-203,69,-210,61,-212,50,-212,39,-212,28,-206,23,-195,22,-185,18,-179,9,-178,-2,-177,-13,-178,-24,-179,-35,-185,-44,-195,-47,-206,-48,-209,-56,-209,-67,-211,-78,-218,-85,-229,-88,-240,-89,-251,-90,-262,-89,-273,-89,-283,-87,-293,-82,-298,-72,-299,-61,-300,-50,-309,-47,-320,-44,-326,-35,-328,-25,-329,-14,-328,-3,-327,8,-322,18,-312,22,-303,26,-303,37,-303,47,-303,58,-302,69,-302,80,-301,91,-298,102,-294,112,-288,121,-280,128,-270,133,-260,136,-249,138,-238,138]]},{"char":"i","paths":[[-116,139,-105,138,-94,137,-84,133,-77,125,-75,114,-73,103,-72,92,-72,81,-71,70,-71,59,-71,48,-71,37,-71,26,-71,15,-71,4,-72,-7,-73,-18,-75,-29,-77,-40,-85,-48,-95,-51,-106,-51,-117,-52,-129,-51,-139,-50,-150,-47,-157,-39,-159,-28,-161,-17,-162,-6,-162,5,-163,16,-163,27,-163,38,-163,49,-163,60,-162,71,-162,82,-161,93,-160,104,-158,115,-155,126,-148,134,-138,137,-127,138,-116,139],[-161,-103,-159,-92,-155,-82,-147,-74,-136,-70,-125,-68,-114,-68,-103,-69,-92,-72,-82,-78,-76,-87,-73,-98,-73,-109,-76,-120,-82,-129,-92,-135,-103,-138,-114,-139,-125,-138,-136,-137,-147,-132,-155,-125,-159,-114]]},{"char":"t","paths":[[41,139,52,138,63,137,74,134,83,129,89,120,91,109,92,98,90,87,85,78,75,74,65,69,58,61,56,50,56,39,56,28,62,23,73,22,83,18,89,9,90,-2,90,-13,90,-24,89,-35,83,-44,72,-47,62,-48,59,-56,59,-67,57,-78,50,-85,39,-88,28,-89,17,-90,6,-89,-5,-89,-15,-87,-25,-82,-30,-72,-31,-61,-32,-50,-41,-47,-52,-44,-58,-35,-60,-25,-61,-14,-60,-3,-59,8,-54,18,-44,22,-35,26,-35,37,-35,47,-35,58,-34,69,-34,80,-33,91,-30,102,-26,112,-20,121,-12,128,-2,133,8,136,19,138,30,138]]},{"char":"c","paths":[[196,139,207,138,218,138,229,136,240,134,250,130,259,124,267,117,273,108,277,97,278,87,278,76,275,65,269,56,259,51,249,50,238,50,227,54,219,61,214,70,205,76,194,74,188,65,186,55,185,44,186,33,187,22,193,13,204,11,213,17,219,26,228,33,238,35,249,36,260,33,269,27,274,18,277,7,277,-4,275,-14,271,-25,264,-33,256,-40,246,-45,235,-48,225,-50,214,-51,203,-52,192,-52,181,-51,170,-50,159,-48,149,-45,139,-40,130,-34,122,-27,115,-18,111,-8,107,3,105,13,104,24,103,35,103,46,103,57,104,68,106,79,108,89,112,99,118,109,125,117,133,124,143,129,153,133,164,136,174,138,185,138,196,139]]},{"char":"h","paths":[[346,139,357,138,368,137,378,134,384,125,386,115,386,104,385,93,385,82,384,71,384,60,383,49,383,39,383,28,386,17,394,11,404,14,407,24,408,35,408,46,407,57,407,68,406,79,406,90,405,100,405,111,405,122,409,132,419,137,430,138,441,139,452,139,462,138,473,137,483,133,490,125,493,114,495,104,497,93,498,82,499,71,499,60,500,50,500,39,500,28,500,17,499,6,498,-5,496,-15,492,-26,486,-35,478,-42,469,-48,458,-50,448,-52,437,-51,426,-50,415,-47,406,-42,397,-36,389,-29,382,-20,382,-31,382,-42,382,-53,382,-63,383,-74,383,-85,380,-96,372,-103,362,-106,351,-107,340,-107,329,-107,318,-105,308,-102,300,-95,296,-85,295,-74,293,-63,293,-52,292,-41,292,-31,291,-20,291,-9,291,2,291,13,291,24,291,35,291,46,292,57,292,67,293,78,294,89,295,100,296,111,299,121,304,131,314,136,324,138,335,138,346,139]]}]};
			let ablesData = {"size":1000,"letters":[{"char":"a","paths":[[-432,132,-420,132,-409,129,-398,124,-389,116,-382,107,-377,97,-377,103,-377,115,-372,125,-361,130,-350,132,-338,132,-326,132,-315,132,-303,130,-292,126,-284,118,-280,107,-279,95,-278,84,-277,72,-277,60,-277,49,-277,37,-277,25,-277,13,-277,2,-277,-10,-277,-22,-278,-33,-279,-45,-282,-56,-288,-66,-299,-71,-310,-72,-322,-73,-334,-73,-345,-72,-357,-71,-367,-66,-373,-55,-373,-44,-375,-38,-381,-48,-388,-57,-398,-65,-408,-70,-419,-72,-431,-73,-443,-72,-454,-69,-465,-64,-474,-57,-482,-48,-488,-38,-492,-28,-495,-16,-498,-5,-499,7,-500,18,-500,30,-500,42,-499,53,-498,65,-496,77,-493,88,-488,99,-483,109,-475,118,-465,125,-455,129,-443,132],[-409,30,-408,18,-406,7,-399,-3,-388,-5,-377,0,-376,11,-376,23,-376,34,-377,46,-380,57,-388,65,-400,63,-406,53,-408,42]]},{"char":"b","paths":[[-102,132,-90,132,-78,129,-67,125,-58,118,-50,110,-44,100,-39,89,-36,78,-34,66,-33,54,-32,43,-32,31,-32,19,-32,7,-34,-4,-36,-16,-38,-27,-43,-38,-48,-49,-56,-58,-65,-65,-76,-69,-87,-72,-99,-73,-111,-72,-122,-70,-133,-65,-142,-58,-149,-48,-155,-38,-156,-40,-156,-52,-155,-64,-155,-76,-155,-87,-154,-99,-154,-111,-158,-122,-167,-129,-179,-131,-191,-132,-202,-132,-214,-132,-226,-132,-237,-129,-247,-122,-252,-112,-254,-100,-255,-89,-256,-77,-256,-65,-256,-53,-256,-42,-256,-30,-256,-18,-256,-6,-256,6,-256,17,-256,29,-255,41,-255,53,-255,64,-254,76,-253,88,-252,100,-250,111,-245,122,-236,129,-224,131,-212,132,-201,132,-189,132,-177,131,-166,127,-159,118,-158,106,-158,97,-152,107,-144,116,-135,123,-125,129,-113,132],[-157,40,-156,28,-155,16,-153,5,-145,-4,-134,-5,-126,4,-123,15,-123,27,-123,38,-125,50,-130,60,-141,65,-152,62,-156,52]]},{"char":"l","paths":[[38,132,50,132,61,131,72,127,80,119,84,108,86,96,87,84,88,73,88,61,88,49,88,37,88,26,88,14,88,2,88,-10,88,-21,88,-33,88,-45,88,-57,87,-68,87,-80,86,-92,85,-103,82,-115,76,-125,66,-130,54,-132,42,-132,31,-132,19,-132,7,-129,-3,-124,-9,-114,-11,-103,-13,-91,-13,-79,-14,-67,-14,-56,-14,-44,-14,-32,-14,-20,-14,-9,-14,3,-14,15,-14,26,-14,38,-14,50,-14,62,-13,73,-12,85,-11,97,-9,108,-5,119,3,127,14,131,26,132]]},{"char":"e","paths":[[219,132,231,132,242,131,254,130,266,128,277,124,287,119,297,112,304,102,308,91,309,80,307,68,300,58,290,54,278,54,267,57,257,63,247,70,236,74,225,75,213,74,202,69,195,60,199,55,210,55,222,55,234,55,246,53,257,51,268,47,279,42,289,36,297,27,303,17,307,6,309,-6,308,-17,306,-29,302,-40,295,-49,286,-57,276,-62,265,-67,253,-69,242,-71,230,-72,218,-73,207,-73,195,-72,183,-71,172,-68,160,-65,150,-60,140,-54,131,-47,123,-38,117,-28,112,-17,109,-5,107,6,106,18,106,30,106,41,107,53,110,65,113,76,118,87,124,97,131,106,140,113,150,119,161,124,172,127,184,130,196,131,207,132],[190,8,192,-4,198,-15,209,-20,222,-19,229,-10,226,2,215,7,203,9]]},{"char":"s","paths":[[407,132,419,132,431,131,442,130,454,128,465,124,475,119,484,112,492,103,497,92,499,81,500,69,499,57,497,46,492,35,484,27,475,20,465,14,454,9,443,4,433,-1,422,-6,415,-15,420,-25,431,-25,441,-19,449,-11,458,-3,469,0,481,-1,491,-7,496,-18,496,-29,495,-41,489,-51,481,-59,471,-65,459,-69,448,-71,436,-72,425,-73,413,-73,401,-73,390,-72,378,-70,367,-67,356,-63,345,-58,336,-50,330,-41,325,-30,323,-19,322,-7,323,5,326,16,332,26,340,35,349,42,359,48,369,53,380,58,391,62,401,67,406,78,397,84,385,83,375,78,366,71,358,62,348,56,337,55,326,60,320,70,318,81,319,93,322,104,329,113,339,120,349,125,361,128,372,130,384,132,395,132]]}]};
		</script>
	</head>

	<body>
		<script>

			// create a new pattern
			let pattern = new Stitch.Pattern(350, 200);

			// add the threads
			let redThread = pattern.addThread(255, 0, 0);
			let greenThread = pattern.addThread(0, 255, 0);
			let blueThread = pattern.addThread(0, 0, 255);

			// create the border run
			let padding = 5;
			let borderLine = [
				new Stitch.Utils.Vector(padding, padding),
				new Stitch.Utils.Vector(pattern.vWidth - padding, padding),
				new Stitch.Utils.Vector(pattern.vWidth - padding, pattern.vHeight - padding),
				new Stitch.Utils.Vector(padding, pattern.vHeight - padding)
			];
			let roundedBorderLine = Stitch.Utils.getRoundedLine(borderLine, 4 * padding, true);
			let borderRun = new StitchRuns.Satin(2 * padding, 0.1);
			for (let point of roundedBorderLine) {
				borderRun.addPoint(point.x, point.y);
			}
			redThread.addRun(borderRun);

			// create the "stitch" run
			for (let letter of stitchData.letters) {
				for (let path of letter.paths) {
					let run = new StitchRuns.Run(1);
					for (let i = 0; i < path.length; i += 2) {
						let x = 0.7 * pattern.vWidth * path[i] / stitchData.size + 0.45 * pattern.vWidth;
						let y = 0.7 * pattern.vWidth * path[i + 1] / stitchData.size + 0.3 * pattern.vHeight;
						run.addPoint(x, y);
					}
					run.points.push(run.points[0]);
					greenThread.addRun(run);
				}
			}

			// create a custom run for "ables"
			class CustomRun extends StitchRunTemaplate {
				constructor(width, density, invert) {
					super();
					this.width = width;
					this.density = density;
					this.invert = invert;
					this.points = [];
				}
				addPoint(x, y) {
					this.points.push(new Stitch.Utils.Vector(x, y));
				}
				getStitches(pixelsPerUnit) {
					if (pixelsPerUnit > 4) {
						let resampled = Stitch.Utils.resampleLineBySpacing(this.points, pixelsPerUnit * this.density, true);
						let stitches = [];
						for (let point of resampled) stitches.push(point);
						stitches.push(stitches[0]);
						return stitches;
					} else {
						let eps = 0;
						let resampled;
						do {
							resampled = Stitch.Utils.resampleLineBySpacing(this.points, pixelsPerUnit * this.density - eps, true);
							eps += 0.01;
						} while (resampled.length % 2 !== 0);
						let stitches = [];
						for (let i = 1; i < resampled.length + 1; i++) {
							let prev = resampled[(i - 1) % resampled.length];
							let curr = resampled[(i + 0) % resampled.length];
							let next = resampled[(i + 1) % resampled.length];
							let normal = new Stitch.Utils.Vector(0, 0);
							normal = normal.add(curr.subtract(prev).normalized());
							normal = normal.add(next.subtract(curr).normalized());
							normal = normal.normalized().rotate(0.5 * Math.PI);
							if (normal.x && normal.y) {
								if (this.invert) {
									if (i % 2 === 0) stitches.push(curr.add(normal.multiply(0.5 * this.width)));
									else stitches.push(curr.subtract(normal.multiply(0.5 * this.width)));
								} else {
									if (i % 2 === 1) stitches.push(curr.add(normal.multiply(0.5 * this.width)));
									else stitches.push(curr.subtract(normal.multiply(0.5 * this.width)));
								}
							}
						}
						stitches.push(stitches[0]);
						return stitches;
					}
				}
			}

			// create the "ables" run
			for (let letter of ablesData.letters) {
				for (let path of letter.paths) {
					let run = new CustomRun(2, 2, false);
					let runInverted = new CustomRun(2, 2, true);
					for (let i = 0; i < path.length; i += 2) {
						let x = 0.7 * pattern.vWidth * path[i] / stitchData.size + 0.55 * pattern.vWidth;
						let y = 0.7 * pattern.vWidth * path[i + 1] / stitchData.size + 0.7 * pattern.vHeight;
						run.addPoint(x, y);
						runInverted.addPoint(x, y);
					}
					blueThread.addRun(run);
					blueThread.addRun(runInverted);
				}
			}

			// draw the pattern
			let svg = pattern.drawSvg(window.innerWidth, window.innerHeight);

			// redraw pattern as the window is resized
			window.addEventListener("resize", Stitch.Utils.debounce(() => {
				document.body.removeChild(svg);
				svg = pattern.drawSvg(window.innerWidth, window.innerHeight);
			}));

			// create the function for stitchables output
			function generateEmbroiderySVG(widthMM, heightMM) {
				return pattern.getSvgString(widthMM, heightMM);
			}

			// print the string out to the console for testing
			console.log(generateEmbroiderySVG(Stitch.Utils.inchesToMillimeters(2), Stitch.Utils.inchesToMillimeters(2)));

			// download the embroidery file
			Stitch.IO.write(pattern, "businessCard.dst", Stitch.Utils.inchesToMillimeters(3.5), Stitch.Utils.inchesToMillimeters(2));
			Stitch.IO.write(pattern, "businessCard.pes", Stitch.Utils.inchesToMillimeters(3.5), Stitch.Utils.inchesToMillimeters(2));

		</script>
	</body>

</html>